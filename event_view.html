<!DOCTYPE html>
<html>
<head>
  <title>Howen VSS Alarm Viewer</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }
    .filter-group {
      margin: 10px 0;
    }
    #videoFrame {
      width: 100%;
      max-width: 800px;
      height: 450px;
      border: 1px solid #ccc;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>Alarm Viewer</h2>

  <label for="vehicleSelect">Select Vehicle:</label>
  <select id="vehicleSelect"></select>

  <div class="filter-group">
    <label for="startTime">Start Time:</label>
    <input type="datetime-local" id="startTime">
    <label for="endTime">End Time:</label>
    <input type="datetime-local" id="endTime">
    <button onclick="loadAlarms()">Filter</button>
  </div>

  <iframe id="videoFrame"></iframe>

  <table id="alarmTable">
    <thead>
      <tr>
        <th>Alarm Time</th>
        <th>Replay Video</th>
        <th>Real-time Play</th>
        <th>Download Video</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  

  <script>
    const apiBase = "https://vss.howentech.com/vss";
    const playbackBase = "https://vss.howentech.com:36301/vss";
    let token = "";

    async function login() {
      const res = await fetch(`${apiBase}/user/apiLogin.action`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: "Gpsgatetest",
          password: "fcfa7fbed9656e1245f14219cf560ee9"
        })
      });
      const data = await res.json();
      token = data.data.token;
    }

    async function loadVehicles() {
      const res = await fetch(`${apiBase}/vehicle/findAll.action`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, pageNum: 1, pageCount: 100 })
      });
      const data = await res.json();
      const select = document.getElementById("vehicleSelect");
      data.data.dataList.forEach(device => {
        const option = document.createElement("option");
        option.value = device.deviceno;
        option.text = device.devicename;
        select.appendChild(option);
      });

      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
      document.getElementById("startTime").value = todayStart.toISOString().slice(0, 16);
      document.getElementById("endTime").value = now.toISOString().slice(0, 16);

      loadAlarms();
    }

    async function loadAlarms() {
      const deviceID = document.getElementById("vehicleSelect").value;
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;

      if (!start || !end) {
        alert("Please select both start and end times.");
        return;
      }

      const res = await fetch(`${apiBase}/alarm/apiFindAllByTime.action`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token,
          deviceID,
          pageNum: 1,
          pageCount: 20,
          beginTime: start.replace("T", " ") + ":00",
          endTime: end.replace("T", " ") + ":59"
        })
      });

      const data = await res.json();
      const tbody = document.getElementById("alarmTable").querySelector("tbody");
      tbody.innerHTML = "";

      for (const alarm of data.data.dataList) {
        const row = document.createElement("tr");

        const timeCell = document.createElement("td");
        timeCell.textContent = alarm.createtime;

        const replayCell = document.createElement("td");
        const replayBtn = document.createElement("button");
        replayBtn.textContent = "Replay";
        replayBtn.onclick = () => {
          const iframe = document.getElementById("videoFrame");
          const encodedPath = btoa(alarm.alarmGps || "");
          iframe.src = `${playbackBase}/apiPage/ReplayAlarmServerVideo.html?token=${token}&deviceId=${deviceID}&chs=1_2_3_4&fpath=${encodedPath}`;
          iframe.style.display = "block";
          iframe.scrollIntoView({ behavior: "smooth" });
        };
        replayCell.appendChild(replayBtn);

        const realtimeCell = document.createElement("td");
        const realtimeBtn = document.createElement("button");
        realtimeBtn.textContent = "Live";
        realtimeBtn.onclick = () => {
          const iframe = document.getElementById("videoFrame");
          iframe.src = `${playbackBase}/apiPage/RealVideo.html?token=${token}&deviceId=${deviceID}&chs=1_2_3_4&stream=0&wnum=4&panel=1&buffer=2000`;
          iframe.style.display = "block";
          iframe.scrollIntoView({ behavior: "smooth" });
        };
        realtimeCell.appendChild(realtimeBtn);

        const downloadCell = document.createElement("td");
        if (alarm.downUrl && alarm.downUrl.startsWith("http")) {
          const downloadLink = document.createElement("a");
          downloadLink.href = alarm.downUrl;
          downloadLink.textContent = "Download";
          downloadLink.download = "alarm_video.mp4";
          downloadLink.target = "_blank";
          downloadCell.appendChild(downloadLink);
        } else {
          downloadCell.textContent = "No download available";
        }

        row.append(timeCell, replayCell, realtimeCell, downloadCell);
        tbody.appendChild(row);
      }
    }

    (async () => {
      await login();
      await loadVehicles();
    })();
  </script>
</body>
</html>
